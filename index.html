<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta
      name="description"
      content="Responsive Admin &amp; Dashboard Template based on Bootstrap 5"
    />
    <meta name="author" content="AdminKit" />
    <meta
      name="keywords"
      content="adminkit, bootstrap, bootstrap 5, admin, dashboard, template, responsive, css, sass, html, theme, front-end, ui kit, web"
    />

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link rel="shortcut icon" href="img/icons/smart-icon.png" />
    <style>
      .indicator-container {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    
      .indicator-box {
        padding: 10px 30px;
        font-size: 1.5rem;
        font-weight: bold;
        border-radius: 15px;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: all 0.3s ease-in-out;
      }
    
      .indicator-on {
        background-color: #28a745; /* Green for "On" */
        color: white;
      }
    
      .indicator-off {
        background-color: #dc3545; /* Red for "Off" */
        color: white;
      }
      
      .stat-box {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}
.stat-box h4 {
  margin-bottom: 10px;
}
.stat-box p {
  font-size: 24px;
  font-weight: bold;
}



      @media (max-width: 768px) {
        .indicator-box {
          font-size: 1.2rem;
          padding: 8px 20px;
        }
      }
    </style>    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link rel="canonical" href="https://demo-basic.adminkit.io/" />
    <link
      rel="canonical"
      href="https://demo-basic.adminkit.io/maps-google.html"
    />

    <title>Smart Misting System App</title>

    <link href="css/app.css" rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <div class="wrapper">
      <!-- Sidebar -->
      <nav id="sidebar" class="sidebar js-sidebar">
        <div class="sidebar-content js-simplebar">
          <a class="sidebar-brand d-flex align-items-center" href="index.html">
            <img src="img/icons/smart-icon.png" alt="Smart Icon" style="width: 48px; height: 48px; margin-right: 12px" />
            <span class="align-middle" style="font-size: 16px">Smart Misting System App</span>
          </a>
          <ul class="sidebar-nav">
            <li class="sidebar-item active">
              <a class="sidebar-link" href="index.html">
                <i class="align-middle" data-feather="pie-chart"></i>
                <span class="align-middle">Misting Analytics</span>
              </a>
            </li>
          </ul>
        </div>
      </nav>
      
      <div class="main">
        <nav class="navbar navbar-expand navbar-light navbar-bg">
          <a class="sidebar-toggle js-sidebar-toggle">
            <i class="hamburger align-self-center"></i>
          </a>

          <div class="navbar-collapse collapse">
            <ul class="navbar-nav navbar-align">
              <li class="nav-item dropdown">
                <a
                  class="nav-icon dropdown-toggle"
                  href="#"
                  id="alertsDropdown"
                  data-bs-toggle="dropdown"
                >
                  <div class="position-relative">
                    <i class="align-middle" data-feather="bell"></i>
                    <span class="indicator">4</span>
                  </div>
                </a>
                <div
                  class="dropdown-menu dropdown-menu-lg dropdown-menu-end py-0"
                  aria-labelledby="alertsDropdown"
                >
                  <div class="dropdown-menu-header">4 New Notifications</div>
                  <div class="list-group">
                    <a href="#" class="list-group-item">
                      <div class="row g-0 align-items-center">
                        <div class="col-2">
                          <i
                            class="text-danger"
                            data-feather="alert-circle"
                          ></i>
                        </div>
                        <div class="col-10">
                          <div class="text-dark">Update completed</div>
                          <div class="text-muted small mt-1">
                            Restart server 12 to complete the update.
                          </div>
                          <div class="text-muted small mt-1">30m ago</div>
                        </div>
                      </div>
                    </a>
                    <a href="#" class="list-group-item">
                      <div class="row g-0 align-items-center">
                        <div class="col-2">
                          <i class="text-warning" data-feather="bell"></i>
                        </div>
                        <div class="col-10">
                          <div class="text-dark">Lorem ipsum</div>
                          <div class="text-muted small mt-1">
                            Aliquam ex eros, imperdiet vulputate hendrerit et.
                          </div>
                          <div class="text-muted small mt-1">2h ago</div>
                        </div>
                      </div>
                    </a>
                    <a href="#" class="list-group-item">
                      <div class="row g-0 align-items-center">
                        <div class="col-2">
                          <i class="text-primary" data-feather="home"></i>
                        </div>
                        <div class="col-10">
                          <div class="text-dark">Login from 192.186.1.8</div>
                          <div class="text-muted small mt-1">5h ago</div>
                        </div>
                      </div>
                    </a>
                    <a href="#" class="list-group-item">
                      <div class="row g-0 align-items-center">
                        <div class="col-2">
                          <i class="text-success" data-feather="user-plus"></i>
                        </div>
                        <div class="col-10">
                          <div class="text-dark">New connection</div>
                          <div class="text-muted small mt-1">
                            Christina accepted your request.
                          </div>
                          <div class="text-muted small mt-1">14h ago</div>
                        </div>
                      </div>
                    </a>
                  </div>
                  <div class="dropdown-menu-footer">
                    <a href="#" class="text-muted">Show all notifications</a>
                  </div>
                </div>
              </li>
              <li class="nav-item dropdown">
                <a
                  class="nav-icon dropdown-toggle"
                  href="#"
                  id="messagesDropdown"
                  data-bs-toggle="dropdown"
                >
                  <div class="position-relative">
                    <i class="align-middle" data-feather="message-square"></i>
                  </div>
                </a>
                <div
                  class="dropdown-menu dropdown-menu-lg dropdown-menu-end py-0"
                  aria-labelledby="messagesDropdown"
                >
                  <div class="dropdown-menu-header">
                    <div class="position-relative">4 New Messages</div>
                  </div>
                  <div class="list-group">
                    <a href="#" class="list-group-item">
                      <div class="row g-0 align-items-center">
                        <div class="col-2">
                          <img
                            src="img/avatars/avatar-5.jpg"
                            class="avatar img-fluid rounded-circle"
                            alt="Vanessa Tucker"
                          />
                        </div>
                        <div class="col-10 ps-2">
                          <div class="text-dark">Vanessa Tucker</div>
                          <div class="text-muted small mt-1">
                            Nam pretium turpis et arcu. Duis arcu tortor.
                          </div>
                          <div class="text-muted small mt-1">15m ago</div>
                        </div>
                      </div>
                    </a>
                    <a href="#" class="list-group-item">
                      <div class="row g-0 align-items-center">
                        <div class="col-2">
                          <img
                            src="img/avatars/avatar-2.jpg"
                            class="avatar img-fluid rounded-circle"
                            alt="William Harris"
                          />
                        </div>
                        <div class="col-10 ps-2">
                          <div class="text-dark">William Harris</div>
                          <div class="text-muted small mt-1">
                            Curabitur ligula sapien euismod vitae.
                          </div>
                          <div class="text-muted small mt-1">2h ago</div>
                        </div>
                      </div>
                    </a>
                    <a href="#" class="list-group-item">
                      <div class="row g-0 align-items-center">
                        <div class="col-2">
                          <img
                            src="img/avatars/avatar-4.jpg"
                            class="avatar img-fluid rounded-circle"
                            alt="Christina Mason"
                          />
                        </div>
                        <div class="col-10 ps-2">
                          <div class="text-dark">Christina Mason</div>
                          <div class="text-muted small mt-1">
                            Pellentesque auctor neque nec urna.
                          </div>
                          <div class="text-muted small mt-1">4h ago</div>
                        </div>
                      </div>
                    </a>
                    <a href="#" class="list-group-item">
                      <div class="row g-0 align-items-center">
                        <div class="col-2">
                          <img
                            src="img/avatars/avatar-3.jpg"
                            class="avatar img-fluid rounded-circle"
                            alt="Sharon Lessman"
                          />
                        </div>
                        <div class="col-10 ps-2">
                          <div class="text-dark">Sharon Lessman</div>
                          <div class="text-muted small mt-1">
                            Aenean tellus metus, bibendum sed, posuere ac,
                            mattis non.
                          </div>
                          <div class="text-muted small mt-1">5h ago</div>
                        </div>
                      </div>
                    </a>
                  </div>
                  <div class="dropdown-menu-footer">
                    <a href="#" class="text-muted">Show all messages</a>
                  </div>
                </div>
              </li>
              <li class="nav-item dropdown">
                <a
                  class="nav-icon dropdown-toggle d-inline-block d-sm-none"
                  href="#"
                  data-bs-toggle="dropdown"
                >
                  <i class="align-middle" data-feather="settings"></i>
                </a>

                <a
                  class="nav-link dropdown-toggle d-none d-sm-inline-block"
                  href="#"
                  data-bs-toggle="dropdown"
                >
                  <img
                    src="img/avatars/chester.jpg"
                    class="avatar img-fluid rounded me-1"
                    alt="Charles Hall"
                  />
                  <span class="text-dark">Chester Fabrigaras</span>
                </a>
                <div class="dropdown-menu dropdown-menu-end">
                  <a class="dropdown-item" href="pages-profile.html"
                    ><i class="align-middle me-1" data-feather="user"></i>
                    Profile</a
                  >
                  <a class="dropdown-item" href="#"
                    ><i class="align-middle me-1" data-feather="pie-chart"></i>
                    Analytics</a
                  >
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="index.html"
                    ><i class="align-middle me-1" data-feather="settings"></i>
                    Settings & Privacy</a
                  >
                  <a class="dropdown-item" href="#"
                    ><i
                      class="align-middle me-1"
                      data-feather="help-circle"
                    ></i>
                    Help Center</a
                  >
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="#">Log out</a>
                </div>
              </li>
            </ul>
          </div>
        </nav>

        <main class="content">
          <div class="container-fluid p-0">
            <div class="container-fluid p-0">
              <div class="card mb-4 shadow">
                <div class="card-body text-center">
                  <h5 class="card-title mb-4 text-primary fw-bold"> Misting Control Panel</h5>
              
                  <!-- Misting Status Indicator (now inside the card) -->
                  <div id="misting-indicator" class="mb-4 px-4 py-2 rounded-pill mx-auto d-inline-block text-white fw-semibold"
                       style="background-color: #dc3545;">
                    Smart Misting is Off
                  </div>
              
                  <!-- Controls -->
                  <div class="d-flex justify-content-center align-items-center flex-wrap gap-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="modeToggle">
                      <label class="form-check-label" for="modeToggle">Auto Mode</label>
                    </div>
              
                    <button class="btn btn-success" id="startManualBtn">Start Misting</button>
                  </div>
                </div>
              </div>
              
            </div>
            
            <h1 class="h3 mb-4 text-center"><strong>Environmental</strong> Ambiance</h1>

              <div class="container-fluid">
                <div class="row justify-content-center">
                  <div class="col-xl-10">
                    <div class="row g-4">
        <!-- Humidity Card -->
                <div class="col-md-6 col-lg-6">
                  <div class="card p-3 shadow-lg">
            <div class="card-body text-center">
              <h5 class="card-title">Humidity</h5>
              <i data-feather="droplet" class="text-primary mb-2" style="width: 36px; height: 36px;"></i>
              <h1 class="display-5" id="humidity-value">--%</h1>
              <span class="text-muted" id="humidity-change">Fetching data...</span>
            </div>
          </div>
        </div>

        <!-- Temperature Card -->
        <div class="col-md-6 col-lg-6">
          <div class="card p-3 shadow-lg">
            <div class="card-body text-center">
              <h5 class="card-title">Temperature</h5>
              <i data-feather="thermometer" class="text-danger mb-2" style="width: 36px; height: 36px;"></i>
              <h1 class="display-5" id="temperature-value">--°C</h1>
              <span class="text-muted" id="temperature-change">Fetching data...</span>
            </div>
          </div>
        </div>

        <!-- Air Quality Card -->
        <div class="col-md-6 col-lg-6">
          <div class="card p-3 shadow-lg">
            <div class="card-body text-center">
              <h5 class="card-title">Air Quality</h5>
              <i data-feather="wind" class="text-info mb-2" style="width: 36px; height: 36px;"></i>
              <h1 class="display-5" id="air-quality-value">--</h1>
              <span class="text-muted" id="air-quality-index">Fetching data...</span>
            </div>
          </div>
        </div>

        <!-- Water Level Card -->
        <div class="col-md-6 col-lg-6">
          <div class="card p-3 shadow-lg">
            <div class="card-body text-center">
              <h5 class="card-title">Water Level</h5>
              <i data-feather="droplet" class="text-primary mb-2" style="width: 36px; height: 36px;"></i>
              <h1 class="display-5" id="water-level-value">--%</h1>
              <span class="text-muted" id="water-level-status">Fetching data...</span>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
          </div>
        
              <!-- <div class="col-xl-6 col-xxl-7">
                <div class="card flex-fill w-100 mt-4">
                  <div class="card-body">
                    <h5 class="card-title">Misting Activation Frequency</h5>
                    <canvas id="mistingBarChart" height="100"></canvas>
                  </div>
                </div>
              </div> -->
              

              
              <!-- <div class="col-xl-6 col-xxl-7">
                <div class="card flex-fill w-100">
                  <div
                    class="card-header d-flex justify-content-between align-items-center"
                  >
                    <h5 class="card-title mb-0">Recorded Data</h5>
                    <div>
                      <button
                        id="show-temperature"
                        class="btn btn-primary btn-sm"
                      >
                        Temperature
                      </button>
                      <button
                        id="show-humidity"
                        class="btn btn-secondary btn-sm"
                      >
                        Humidity
                      </button>
                      <button id="show-both" class="btn btn-success btn-sm">
                        Show Both
                      </button>
                    </div>
                  </div>
                  <div class="card-body py-3">
                    <div class="chart chart-sm">
                      <canvas id="chartjs-dashboard-line"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div> -->
            
            <div class="container mt-5">
              <h2 class="text-center mb-4"> Smart Misting Analytics</h2>
            
              <!-- Average Boxes -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <div class="card text-center shadow-sm">
                    <div class="card-body">
                      <h5 class="card-title">Average Temperature</h5>
                      <h3 id="avg-temperature" class="text-primary">-- °C</h3>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card text-center shadow-sm">
                    <div class="card-body">
                      <h5 class="card-title">Average Humidity</h5>
                      <h3 id="avg-humidity" class="text-primary">-- %</h3>
                    </div>
                  </div>
                </div>
              </div>
            
              <!-- Sensor Line Chart -->
              <div class="card shadow-sm">
                <div class="card-body">
                  <h5 class="card-title text-center">Sensor Readings Over Time</h5>
                  <canvas id="sensorChart" height="100"></canvas>
                </div>
              </div>
            </div>
            
      <!-- <div class="col-12 col-lg-4 col-xxl-3 d-flex">
        <div class="card flex-fill w-100">
          <div class="card-header">
            <h5 class="card-title mb-0">Misting Cycles</h5>
          </div>
          <div class="card-body d-flex w-100">
            <div class="align-self-center chart chart-lg">
              <canvas id="chartjs-dashboard-bar"></canvas>
            </div>
          </div>
        </div>
        </div> -->
            
            <!-- <div class="row">
              <div class="col-12 col-md-6 col-xxl-3 d-flex order-2 order-xxl-3">
                <div class="card flex-fill w-100">
                  <div class="card-header">
                    <h5 class="card-title mb-0">System Metrics</h5>
                  </div>
                  <div class="card-body d-flex">
                    <div class="align-self-center w-100">
                      <div class="py-3">
                        <div class="chart chart-xs">
                          <canvas id="chartjs-dashboard-pie"></canvas>
                        </div>
                      </div>

                      <table class="table table-striped mb-0">
                        <tbody>
                          <tr>
                            <td><strong>Water Used (Liters)</strong></td>
                            <td class="text-end">250</td>
                          </tr>
                          <tr>
                            <td><strong>System Efficiency (%)</strong></td>
                            <td class="text-end">80%</td>
                          </tr>
                          <tr>
                            <td><strong>Idle Time (Hours)</strong></td>
                            <td class="text-end">5</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div> -->
              <!-- <div
                class="col-12 col-md-12 col-xxl-6 d-flex order-3 order-xxl-2"
              >
                <div class="card flex-fill w-100">
                  <div class="card-header">
                    <h5 class="card-title mb-0">Real-Time</h5>
                  </div>
                  <div class="card-body px-4">
                    <div id="default_map" style="height: 350px"></div>
                  </div>
                </div>
              </div> -->
              <div class="row text-center mb-4">
                <!-- ESP32 Status -->
                <div class="col-md-3">
                  <div class="card shadow-sm">
                    <div class="card-body">
                      <h6 class="card-title">ESP32</h6>
                      <span id="esp-status" class="badge bg-success px-3 py-2">Online</span>
                    </div>
                  </div>
                </div>
              
                <!-- Sensor Status -->
                <div class="col-md-3">
                  <div class="card shadow-sm">
                    <div class="card-body">
                      <h6 class="card-title">Sensors</h6>
                      <span id="sensor-status" class="badge bg-success px-3 py-2">OK</span>
                    </div>
                  </div>
                </div>
              
                <!-- MQTT Status -->
                <div class="col-md-3">
                  <div class="card shadow-sm">
                    <div class="card-body">
                      <h6 class="card-title">MQTT</h6>
                      <span id="mqtt-status" class="badge bg-success px-3 py-2">Connected</span>
                    </div>
                  </div>
                </div>
              
                <!-- Mode Status -->
                <div class="col-md-3">
                  <div class="card shadow-sm">
                    <div class="card-body">
                      <h6 class="card-title">Mode</h6>
                      <span id="misting-mode" class="badge bg-info px-3 py-2">Auto</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>  
          </div>
        </div>
        
      
          <div class="container-fluid p-4">
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title mb-0">🕒 Misting History Logs</h5>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-striped align-middle">
                        <thead>
                          <tr>
                            <th>Time</th>
                            <th>Status</th>
                            <th>Mode</th>
                          </tr>
                        </thead>
                        <tbody id="misting-history-body">
                          <!-- History rows -->
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
  
        <!-- Footer -->
        <footer class="footer">
          <div class="container-fluid">
            <div class="row text-muted">
              <div class="col-6 text-start">
                <p class="mb-0">
                  <a class="text-muted" href="#" target="_blank"><strong>4110</strong></a>
                  - <a class="text-muted" href="#" target="_blank"><strong>Smart Misting System</strong></a> &copy;
                </p>
              </div>
              <div class="col-6 text-end">
                <ul class="list-inline">
                  <li class="list-inline-item"><a class="text-muted" href="#">Support</a></li>
                  <li class="list-inline-item"><a class="text-muted" href="#">Help Center</a></li>
                  <li class="list-inline-item"><a class="text-muted" href="#">Privacy</a></li>
                  <li class="list-inline-item"><a class="text-muted" href="#">Terms</a></li>
                </ul>
              </div>
            </div>
          </div>
        </footer>
      </div> <!-- END of .main -->
    </div> <!-- END of .wrapper -->
  </body>
        
    <script src="js/app.js"></script>
    <script>
  // Alert
   function showAlert(message, type = 'danger') {
  const alertBox = document.createElement('div');
  alertBox.className = `alert alert-${type} alert-dismissible fade show`;
  alertBox.role = 'alert';
  alertBox.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;

  document.getElementById('alert-container').appendChild(alertBox);

  // Auto-hide after 5 seconds
  setTimeout(() => {
    alertBox.remove();
  }, 5000);
}

// Example use
showAlert("⚠️ Low water level!", "warning");

   async function fetchSensorData() {
  // MQTT Client Setup
  const client = mqtt.connect('ws://localhost:9001'); // Local MQTT broker

  // MQTT Connection handling
  client.on('connect', () => {
    console.log('Connected to MQTT broker');
    client.subscribe('smartmisting/sensors'); // Subscribe to sensor data topic
    client.subscribe('smartmisting/status'); // Subscribe to system status topic
    updateSystemStatus({ mqttConnected: true });
  });

  client.on('message', (topic, message) => {
    try {
      const data = JSON.parse(message.toString());
      
      if (topic === 'smartmisting/sensors') {
        // Update sensor readings
        document.getElementById('temperature-value').textContent = `${data.temperature}°C`;
        document.getElementById('humidity-value').textContent = `${data.humidity}%`;
        document.getElementById('air-quality-value').textContent = data.airQuality || '--';
        document.getElementById('water-level-value').textContent = `${data.waterLevel}%`;
        
        // Update status messages
        document.getElementById('humidity-change').textContent = 'Data updated successfully';
        document.getElementById('temperature-change').textContent = 'Data updated successfully';
        document.getElementById('air-quality-index').textContent = data.airQualityIndex || 'Fetching data...';
        document.getElementById('water-level-status').textContent = data.waterLevelStatus || 'Fetching data...';
        
        // Update misting indicator
        const mistingIndicator = document.getElementById('misting-indicator');
        mistingIndicator.textContent = data.misting ? 'Smart Misting is On' : 'Smart Misting is Off';
        mistingIndicator.style.backgroundColor = data.misting ? '#28a745' : '#dc3545';
      }
      
      if (topic === 'smartmisting/status') {
        // Update system status
        updateSystemStatus({
          espOnline: data.espOnline,
          sensorsOk: data.sensorsOk,
          mqttConnected: true,
          mode: data.mode
        });
      }
    } catch (error) {
      console.error('Error processing MQTT message:', error);
    }
  });

  client.on('error', (err) => {
    console.error('MQTT connection error:', err);
    updateSystemStatus({ mqttConnected: false });
  });
}

// Control Panel Event Listeners
document.getElementById('modeToggle').addEventListener('change', function() {
  const isAuto = this.checked;
  client.publish('smartmisting/control', JSON.stringify({
    command: 'setMode',
    mode: isAuto ? 'auto' : 'manual'
  }));
});

document.getElementById('startManualBtn').addEventListener('click', function() {
  const isMisting = this.textContent === 'Stop Misting';
  client.publish('smartmisting/control', JSON.stringify({
    command: isMisting ? 'stop' : 'start'
  }));
});

// Remove the interval since MQTT is event-driven

    </script>


<script>
// Sensor Reading Chart 
const timeLabels = ['10 AM', '11 AM', '12 PM', '1 PM', '2 PM'];
const tempValues = [28.1, 29.0, 30.2, 31.5, 29.8];
const humidityValues = [65, 67, 63, 70, 68];
const ctx = document.getElementById('sensorChart').getContext('2d');
new Chart(ctx, {
  type: 'line',
  data: {
    labels: timeLabels,
    datasets: [
      {
        label: 'Temperature (°C)',
        data: tempValues,
        borderColor: 'rgba(255, 99, 132, 1)',
        fill: false,
        tension: 0.3
      },
      {
        label: 'Humidity (%)',
        data: humidityValues,
        borderColor: 'rgba(54, 162, 235, 1)',
        fill: false,
        tension: 0.3
      }
    ]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: 'bottom' }
    }
  }
});
// Misting Control Panel 
// document.getElementById('modeToggle').addEventListener('change', function () {
//   const isAuto = this.checked;
//   fetch('http://localhost:3000/set-mode', {
//     method: 'POST',
//     headers: { 'Content-Type': 'application/json' },
//     body: JSON.stringify({ mode: isAuto ? 'auto' : 'manual' })
//   });
// });

// document.getElementById('startManualBtn').addEventListener('click', function () {
//   fetch('http://localhost:3000/start-misting', { method: 'POST' });
// });

function updateAnalytics() {
  fetch('http://localhost:3000/sensor-data') // Backend must be running
    .then(response => response.json())
    .then(data => {
      const now = new Date().toLocaleTimeString();

      if (timeLabels.length > 10) {
        timeLabels.shift();
        temperatureData.shift();
        humidityData.shift();
      }

      timeLabels.push(now);
      temperatureData.push(data.temperature);
      humidityData.push(data.humidity);
      sensorChart.update();

// SMART MISTING ANALYTICS PART
      const temperatureData = [28.1, 29.0, 30.2, 31.5, 29.8];
      const humidityData = [65, 67, 63, 70, 68];

      // Update Averages
      const avgTemp = (temperatureData.reduce((a, b) => a + b, 0) / temperatureData.length).toFixed(1);
const avgHumidity = (humidityData.reduce((a, b) => a + b, 0) / humidityData.length).toFixed(1);

document.getElementById('avg-temperature').textContent = `${avgTemp} °C`;
document.getElementById('avg-humidity').textContent = `${avgHumidity} %`;

    })
    .catch(err => console.error("Error fetching data:", err));
}

// Run every 5 seconds
setInterval(updateAnalytics, 5000);
updateAnalytics();
//Misting Logs 
// function fetchMistingLogs() {
//   fetch('http://localhost:3000/misting-history')
//     .then(res => res.json())
//     .then(logs => {
//       const table = document.querySelector('#history-table tbody');
//       table.innerHTML = ''; // Clear old logs
//       logs.forEach(entry => {
//         const row = `
//           <tr>
//             <td>${entry.timestamp}</td>
//             <td>${entry.temperature}°C</td>
//             <td>${entry.humidity}%</td>
//             <td>${entry.volume} ml</td>
//           </tr>`;
//         table.insertAdjacentHTML('beforeend', row);
//       });
//     });
// }

setInterval(fetchMistingLogs, 10000); // Refresh every 10 seconds

</script>
<script>
  const mistingIndicator = document.getElementById('misting-indicator');
  const startManualBtn = document.getElementById('startManualBtn');

  let isMisting = false;

  startManualBtn.addEventListener('click', () => {
    isMisting = !isMisting;
    mistingIndicator.textContent = isMisting ? 'Smart Misting is On' : 'Smart Misting is Off';
    mistingIndicator.style.backgroundColor = isMisting ? '#28a745' : '#dc3545';
    startManualBtn.textContent = isMisting ? 'Stop Misting' : 'Start Misting';
  });
</script>

<script>
  // Misting Activation Frequency Chart
  document.addEventListener('DOMContentLoaded', () => {
    const barCtx = document.getElementById('mistingBarChart').getContext('2d');
    const mistingLabels = [];
    const mistingCounts = [];

    const mistingBarChart = new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: mistingLabels,
        datasets: [{
          label: 'Misting Activations',
          data: mistingCounts,
          backgroundColor: 'rgba(75, 192, 192, 0.6)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Time' } },
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Activations' }
          }
        }
      }
    });

    // Connect to MQTT broker
    const client = mqtt.connect('wss://test.mosquitto.org:8081'); // Public broker for demo

    client.on('connect', () => {
      console.log('MQTT connected');
      client.subscribe('smartmisting/data'); // Subscribe to your ESP32 topic
    });

    client.on('message', (topic, message) => {
      const data = JSON.parse(message.toString());
      const now = new Date().toLocaleTimeString();

      if (data.misting === true) {
        // Only update if misting is active
        if (mistingLabels.length > 10) {
          mistingLabels.shift();
          mistingCounts.shift();
        }

        mistingLabels.push(now);
        mistingCounts.push(1); // or add logic to count volume if you have it

        mistingBarChart.update();
      }
    });

    client.on('error', (err) => {
      console.error('MQTT connection error:', err);
    });
  });
</script>

<!-- <script>
  document.addEventListener('DOMContentLoaded', () => {
    fetch('http://localhost:3000/misting-history')
      .then(res => res.json())
      .then(logs => {
        const tbody = document.getElementById('misting-history-body');
        tbody.innerHTML = ''; // Clear previous rows

        logs.forEach(log => {
          const row = `
            <tr>
              <td>${new Date(log.timestamp).toLocaleString()}</td>
              <td>${log.status}</td>
              <td>${log.mode}</td>
            </tr>`;
          tbody.innerHTML += row;
        });
      })
      .catch(err => console.error("Error fetching misting logs:", err));
      fetch('http://localhost:3000/log-misting', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    status: 'Activated',
    mode: 'Auto',
    timestamp: new Date().toISOString()
  })
});

  });
</script> -->

    <!-- <script>
      // Initialize chart data
      const ctx = document
        .getElementById("chartjs-dashboard-line")
        .getContext("2d");
      const temperatureData = [22, 23, 24, 26, 28, 30, 32]; // Example data
      const humidityData = [50, 55, 53, 60, 62, 64, 67]; // Example data
      const labels = [
        "Monday",
        "Tuesday",
        "Wednesday",
        "Thursday",
        "Friday",
        "Saturday",
        "Sunday",
      ];

      // Create Chart.js instance
      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Temperature (°C)",
              data: temperatureData,
              borderColor: "#007bff",
              backgroundColor: "rgba(0, 123, 255, 0.1)",
              borderWidth: 2,
              tension: 0.4,
              fill: true,
            },
            {
              label: "Humidity (%)",
              data: humidityData,
              borderColor: "#6c757d",
              backgroundColor: "rgba(108, 117, 125, 0.1)",
              borderWidth: 2,
              tension: 0.4,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              grid: {
                color: "rgba(0, 0, 0, 0.05)",
              },
              ticks: {
                color: "#495057",
                font: {
                  size: 12,
                },
              },
            },
            y: {
              grid: {
                color: "rgba(0, 0, 0, 0.05)",
              },
              ticks: {
                color: "#495057",
                font: {
                  size: 12,
                },
              },
            },
          },
          plugins: {
            legend: {
              labels: {
                color: "#495057",
                font: {
                  size: 14,
                },
              },
            },
          },
        },
      });

      // Button Event Listeners
      document
        .getElementById("show-temperature")
        .addEventListener("click", () => {
          chart.data.datasets = [
            {
              label: "Temperature (°C)",
              data: temperatureData,
              borderColor: "#007bff",
              backgroundColor: "rgba(0, 123, 255, 0.1)",
              borderWidth: 2,
              tension: 0.4,
              fill: true,
            },
          ];
          chart.update();
        });

      document.getElementById("show-humidity").addEventListener("click", () => {
        chart.data.datasets = [
          {
            label: "Humidity (%)",
            data: humidityData,
            borderColor: "#6c757d",
            backgroundColor: "rgba(108, 117, 125, 0.1)",
            borderWidth: 2,
            tension: 0.4,
            fill: true,
          },
        ];
        chart.update();
      });

      document.getElementById("show-both").addEventListener("click", () => {
        chart.data.datasets = [
          {
            label: "Temperature (°C)",
            data: temperatureData,
            borderColor: "#007bff",
            backgroundColor: "rgba(0, 123, 255, 0.1)",
            borderWidth: 2,
            tension: 0.4,
            fill: true,
          },
          {
            label: "Humidity (%)",
            data: humidityData,
            borderColor: "#6c757d",
            backgroundColor: "rgba(108, 117, 125, 0.1)",
            borderWidth: 2,
            tension: 0.4,
            fill: true,
          },
        ];
        chart.update();
      });
    </script> -->
    <style>
      .card {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
      }
      .card-title {
        font-size: 18px;
        font-weight: bold;
      }
      .btn {
        margin-left: 5px;
      }
    </style>

    <script>

      // system status 
      function updateSystemStatus({
  espOnline = true,
  sensorsOk = true,
  mqttConnected = true,
  mode = 'Auto'
}) {
  document.getElementById('esp-status').textContent = espOnline ? 'Online' : 'Offline';
  document.getElementById('esp-status').className = `badge px-3 py-2 bg-${espOnline ? 'success' : 'danger'}`;

  document.getElementById('sensor-status').textContent = sensorsOk ? 'OK' : 'Error';
  document.getElementById('sensor-status').className = `badge px-3 py-2 bg-${sensorsOk ? 'success' : 'danger'}`;

  document.getElementById('mqtt-status').textContent = mqttConnected ? 'Connected' : 'Disconnected';
  document.getElementById('mqtt-status').className = `badge px-3 py-2 bg-${mqttConnected ? 'success' : 'warning'}`;

  document.getElementById('misting-mode').textContent = mode;
  document.getElementById('misting-mode').className = `badge px-3 py-2 bg-${mode === 'Auto' ? 'info' : 'secondary'}`;
}

// Example usage
updateSystemStatus({
  espOnline: true,
  sensorsOk: true,
  mqttConnected: false,
  mode: 'Manual'
});

      document.addEventListener("DOMContentLoaded", function () {
        // Pie chart for Smart Misting System
        new Chart(document.getElementById("chartjs-dashboard-pie"), {
          type: "pie",
          data: {
            labels: [
              "Water Used (Liters)",
              "System Efficiency (%)",
              "Idle Time (Hours)",
            ],
            datasets: [
              {
                data: [250, 80, 5], // Example data: Update these values dynamically if needed
                backgroundColor: [
                  "#007bff", // Blue for water used
                  "#28a745", // Green for system efficiency
                  "#ffc107", // Yellow for idle time
                ],
                borderWidth: 2, // Reduced border width for a cleaner look
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: "top",
              },
              tooltip: {
                callbacks: {
                  label: function (tooltipItem) {
                    const label = tooltipItem.label || "";
                    const value = tooltipItem.raw || 0;
                    if (label) {
                      return `${label}: ${value}`;
                    }
                    return value;
                  },
                },
              },
            },
            cutout: "50%", // Create a donut-style chart
          },
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Bar chart for misting system
        new Chart(document.getElementById("chartjs-dashboard-bar"), {
          type: "bar",
          data: {
            labels: [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ],
            datasets: [
              {
                label: "Misting Cycles",
                backgroundColor: "#1e3d77", // Adjust to your theme's color (blue)
                borderColor: "#1e3d77",
                hoverBackgroundColor: "#c05437", // Orange for hover effect
                hoverBorderColor: "#c05437",
                data: [
                  120, 140, 110, 130, 150, 170, 160, 180, 140, 150, 130, 175,
                ], // Example cycles per month
                barPercentage: 0.75,
                categoryPercentage: 0.5,
              },
            ],
          },
          options: {
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true, // Show legend
                position: "top",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  display: true,
                },
                ticks: {
                  stepSize: 20, // Adjust step size as needed
                  color: "#99a0a5", // Gray tick labels
                },
                title: {
                  display: true,
                  text: "Number of Cycles",
                  color: "#1e3d77", // Blue title
                },
              },
              x: {
                grid: {
                  display: false,
                },
                ticks: {
                  color: "#99a0a5", // Gray tick labels
                },
              },
            },
          },
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var markers = [
          {
            coords: [31.230391, 121.473701],
            name: "Shanghai",
          },
          {
            coords: [28.70406, 77.102493],
            name: "Delhi",
          },
          {
            coords: [6.524379, 3.379206],
            name: "Lagos",
          },
          {
            coords: [35.689487, 139.691711],
            name: "Tokyo",
          },
          {
            coords: [23.12911, 113.264381],
            name: "Guangzhou",
          },
          {
            coords: [40.7127837, -74.0059413],
            name: "New York",
          },
          {
            coords: [34.052235, -118.243683],
            name: "Los Angeles",
          },
          {
            coords: [41.878113, -87.629799],
            name: "Chicago",
          },
          {
            coords: [51.507351, -0.127758],
            name: "London",
          },
          {
            coords: [40.416775, -3.70379],
            name: "Madrid ",
          },
        ];
        var map = new jsVectorMap({
          map: "world",
          selector: "#world_map",
          zoomButtons: true,
          markers: markers,
          markerStyle: {
            initial: {
              r: 9,
              strokeWidth: 7,
              stokeOpacity: 0.4,
              fill: window.theme.primary,
            },
            hover: {
              fill: window.theme.primary,
              stroke: window.theme.primary,
            },
          },
          zoomOnScroll: false,
        });
        window.addEventListener("resize", () => {
          map.updateSize();
        });
      });
    </script>
    <!-- <script>
      document.addEventListener("DOMContentLoaded", function () {
        var date = new Date(Date.now() - 5 * 24 * 60 * 60 * 1000);
        var defaultDate =
          date.getUTCFullYear() +
          "-" +
          (date.getUTCMonth() + 1) +
          "-" +
          date.getUTCDate();
        document.getElementById("datetimepicker-dashboard").flatpickr({
          inline: true,
          prevArrow: '<span title="Previous month">&laquo;</span>',
          nextArrow: '<span title="Next month">&raquo;</span>',
          defaultDate: defaultDate,
        });
      });
    </script> -->
    <!----  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const tableBody = document.querySelector("table tbody");
    
      // Example data for misting schedules (this would come from your backend in a real-world app)
      const schedules = [
        { zone: "Zone 1", start: "07:00 AM", end: "07:30 AM", status: "Completed", assignee: "Vanessa Tucker" },
        { zone: "Zone 2", start: "08:00 AM", end: "08:30 AM", status: "In Progress", assignee: "William Harris" },
        { zone: "Zone 3", start: "09:00 AM", end: "09:30 AM", status: "Cancelled", assignee: "Sharon Lessman" },
        { zone: "Zone 4", start: "10:00 AM", end: "10:30 AM", status: "In Progress", assignee: "Vanessa Tucker" },
        { zone: "Zone 5", start: "11:00 AM", end: "11:30 AM", status: "Completed", assignee: "William Harris" },
      ];
    
      // Clear the table body
      tableBody.innerHTML = "";
    
      // Populate the table dynamically
      schedules.forEach((schedule) => {
        const statusClass =
          schedule.status === "Completed"
            ? "bg-success"
            : schedule.status === "In Progress"
            ? "bg-warning"
            : "bg-danger";
    
        const row = `
          <tr>
            <td>${schedule.zone}</td>
            <td class="d-none d-xl-table-cell">${schedule.start}</td>
            <td class="d-none d-xl-table-cell">${schedule.end}</td>
            <td><span class="badge ${statusClass}">${schedule.status}</span></td>
            <td class="d-none d-md-table-cell">${schedule.assignee}</td>
          </tr>
        `;
    
        tableBody.innerHTML += row;
      });
    });
  </script>  -->
    <script>
      function initMaps() {
        // Define bounds for the Philippines
        const philippinesBounds = new google.maps.LatLngBounds(
          { lat: 4.2158, lng: 116.7494 }, // Southwest corner (lower-left)
          { lat: 21.1224, lng: 126.5377 } // Northeast corner (upper-right)
        );

        // Default Map Configuration
        const defaultMapOptions = {
          zoom: 6,
          center: {
            lat: 12.8797, // Latitude of the Philippines' approximate center
            lng: 121.774, // Longitude of the Philippines' approximate center
          },
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          restriction: {
            latLngBounds: philippinesBounds,
            strictBounds: true, // Restrict panning outside the bounds
          },
        };
        new google.maps.Map(
          document.getElementById("default_map"),
          defaultMapOptions
        );

        // Hybrid Map Configuration
        const hybridMapOptions = {
          zoom: 6,
          center: {
            lat: 12.8797,
            lng: 121.774,
          },
          mapTypeId: google.maps.MapTypeId.HYBRID,
          restriction: {
            latLngBounds: philippinesBounds,
            strictBounds: true,
          },
        };
        new google.maps.Map(
          document.getElementById("hybrid_map"),
          hybridMapOptions
        );
      }
    </script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA-aWrwgr64q4b3TEZwQ0lkHI4lZK-moM4&callback=initMaps"
      async
      defer
    ></script>
  </body>
</html>
